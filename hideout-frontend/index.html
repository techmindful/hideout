<!DOCTYPE html>
<html>

  <head>
    <meta charset="UTF-8">
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <title>Hideout</title>
    <script type="text/javascript" src="/main.js"></script>
  </head>

  <body>

    <audio id="notificationAudio2">
      <source src="https://archive.org/download/SuperMarioBros.ThemeMusic/SuperMarioBros.mp3" type="audio/mpeg">
      Can't load notification audio.
    </audio>

    <div id="elm-app"></div>
    <script type="text/javascript">
      var elmApp = Elm.Main.init({
        node: document.getElementById("elm-app")
      , flags:
          { "protocol": location.protocol
          , "host": location.host
          }
      })

      var socket = null;
      var portSendWsMsgHandler = null
      elmApp.ports.port_InitWs.subscribe( function( chatId )
        {
          // Clean up old ws.
          if ( socket != null )
          {
            socket.close();
            elmApp.ports.port_SendWsMsg.unsubscribe( portSendWsMsgHandler );
          }

          const wsProtocol = location.protocol === "https:" ? "wss:" : "ws:";
          const wsHost = `${wsProtocol}//${location.host}`;

          socket = new WebSocket( wsHost + "/api/chat/" + chatId );

          let handleOnOpen = function( event )
            {
              elmApp.ports.port_WsReady.send( "wsReady" );
            }
          socket.addEventListener( "open", handleOnOpen );

          let handleDataFromPortSendWsMsg = function( msg )
            {
              socket.send( msg );
            }
          elmApp.ports.port_SendWsMsg.subscribe( handleDataFromPortSendWsMsg )
          portSendWsMsgHandler = handleDataFromPortSendWsMsg

          let handleDataFromWs = function( event )
            {
              elmApp.ports.port_RecvWsMsg.send( event.data );
            }
          socket.addEventListener( "message", handleDataFromWs );

          //let handleClose = function()
          //  {
          //    socket.close();
          //    elmApp.ports.port_SendWsMsg.unsubscribe( handleDataFromPortSendWsMsg );

          //    //elmApp.ports.port_CloseWs.unsubscribe( handleClose );
          //  }
          ////elmApp.ports.port_CloseWs.subscribe( handleClose );
          //socket.addEventListener( "close", handleClose );
        }
      );

      elmApp.ports.port_NotifyChat.subscribe(
        function()
        {
          document.getElementById( "notificationAudio" ).play();
        }
      );

      window.addEventListener( "beforeunload",
        function( event )
        {
          socket.close();
        }
      ); 

      elmApp.ports.port_DebugLog.subscribe( function( str )
        {
          console.log( str );
        }
      );
    </script>

  </body>

</html>

